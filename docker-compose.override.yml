# docker-compose.override.yml — local development overrides (macOS / Docker Desktop)
#
# Docker Desktop on macOS does NOT support network_mode: host — the container
# cannot reach the host LAN, so mDNS HomeKit discovery won't work locally.
# This override switches the listener to bridge networking and seeds the DB
# with fake events so you can develop and test the UI without a real NAS.
#
# This file is automatically merged by `docker compose up` when present.
# It is NOT used on the NAS (where only docker-compose.yml is used).
# Add docker-compose.override.yml to .gitignore if you don't want it committed,
# or keep it committed as the standard local-dev config.

services:
  postgres:
    # Expose postgres to localhost so the native listener (npm run dev) can reach it
    ports:
      - "5432:5432"

  listener:
    build:
      context: ./listener
    image: homechronicle-listener:local
    pull_policy: never
    # On macOS, run the listener natively with `npm run dev` instead of Docker.
    # This avoids the mDNS limitation of Docker Desktop and port 3001 conflicts.
    # Setting profiles means `docker compose up` will NOT start this container.
    profiles:
      - donotstart

  web:
    build:
      context: ./web
    image: homechronicle-web:local
    pull_policy: never
    environment:
      # Nginx proxies /api to the native listener on the host machine
      - LISTENER_HOST=host.docker.internal
      - LISTENER_PORT=${API_PORT:-3001}
